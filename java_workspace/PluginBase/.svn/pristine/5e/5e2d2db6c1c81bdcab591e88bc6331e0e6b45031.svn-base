<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<project default="dist">

	<!-- Set variables for build directories -->
	<property name="major.minor" value="1.3" />
	<property name="jar.name" value="opkey-pluginbase-${major.minor}.jar" />
	<property name="debuglevel" value="source,lines,vars" />

	<path id="project.classpath">
		<fileset dir="lib" includes="*.jar"/>
	</path>

	<target name="clean">
		<delete dir="bin" />
		<delete dir="build" />
	</target>

	<target name="init" depends="clean">
		<echo>
			Ant: ${ant.version}
			Java: ${ant.java.version} @ ${java.home}
		</echo>
		
		<tstamp>
			<format property="TODAY" pattern="d-MMMM-yyyy" locale="en,GB"/>
		</tstamp>
	</target>
	
	<target name="compile" depends="init">
		<mkdir dir="bin" />
		<copy includeemptydirs="false" todir="bin">
			<fileset dir="src">
				<exclude name="**/*.java" />
			</fileset>
		</copy>
		<javac compiler="modern" debug="true" debuglevel="${debuglevel}" destdir="bin" includeantruntime="false" source="1.7" target="1.7">
			<src path="src" />
			<classpath refid="project.classpath" />
		</javac>
	</target>
		
	<target name="dist" depends="compile, find_revision">

		<echo message="creating jar of the plugin" />
		<property name="base.version" value="${major.minor}.0.${svn-version}" />

		<jar destfile="build/${jar.name}" basedir="bin">
			<manifest>
				<attribute name="Built-By" value="${user.name}" />
				<attribute name="Built-Date" value="${TODAY}"/>

				<attribute name="Specification-Title" value="OpKey Plugin" />
				<attribute name="Specification-Vendor" value="CresTech" />

				<attribute name="Implementation-Title" value="OpKey Plugin Base" />
				<attribute name="Implementation-Version" value="${base.version}" />
				<attribute name="Implementation-Vendor" value="CresTech" />

				<attribute name="Class-Path" value="sqlite-jdbc-3.7.2.jar javautil-3.1.1.jar asm-all-3.1.jar">
				</attribute>
				
			</manifest>
		</jar>



		<!-- now copy all the dependencies -->
		<echo message="Copying all the necessary libraries and files" />
		<copy todir="build">
			<fileset dir="lib" />
		</copy>
		
		<echo>Base jar:       ${jar.name}</echo>
		<echo>Base Version:   ${base.version}</echo>

	</target>

	<target name="find_revision">
		<echo>Finding SVN revision of ${basedir}</echo>

		<!-- find out revision number of HEAD, need svnversion.exe installed on local machine -->
		<exec executable="svnversion" failonerror="true" outputproperty="svn-version">
			<arg line="&quot;${basedir}&quot; -nq" />
			<!--produces output like '601:607MS' or simply '607'-->
			<redirector>
				<outputfilterchain>
					<tokenfilter>
						<!--remove the leading lower version number (if present)-->
						<replaceregex pattern="^[0-9]+:" replace="" />
						<!--remove the trailing MS etc (if present)-->
						<replaceregex pattern="[^0-9]+" replace="" />
					</tokenfilter>
				</outputfilterchain>
			</redirector>
		</exec>

		<echo>Project is at revision: ${svn-version}</echo>
	</target>
	
</project>